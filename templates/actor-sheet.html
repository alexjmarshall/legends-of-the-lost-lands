<form class="flexcol {{cssClass}}" autocomplete="off">

    {{!-- Sheet Header --}}
    <header class="sheet-header">
        <img class="profile-img" src="{{data.img}}" data-edit="img" title="{{data.name}}" />
        <div class="header-fields">
            <h1 class="charname">
                <input name="name" type="text" value="{{data.name}}" placeholder="Name" />
            </h1>
            <div class="resource">
                <label class="left-label">HP</label>
                <input type="number" name="data.hp.value" value="{{systemData.hp.value}}" {{#if isPlayer}}disabled{{/if}}/>
                <span> / </span>
                <input type="number" name="data.hp.max" value="{{systemData.hp.max}}" {{#if isPlayer}}disabled{{/if}}/>
            </div>
            <div class="resource">
                <label class="left-label">XP</label>
                {{#if isCharacter}}
                <input type="number" name="data.xp.value" value="{{systemData.xp.value}}" {{#if isPlayer}}disabled{{/if}}/>
                <span> / </span>
                <input type="number" name="data.xp.max" value="{{systemData.xp.max}}" {{#if isPlayer}}disabled{{/if}}/>
                {{else}}
                <input type="number" name="data.xp.value" value="{{systemData.xp.value}}" disabled/>
                {{/if}}
            </div>
            <div class="properties">
                <div class="property" style="max-width:200px;">
                    <label class="property-label">Summary AC / DR</label>
                    <label class="left-label">B</label>
                    <span class="property-field property-field-ac">{{systemData.ac.total.blunt.ac}} / {{systemData.ac.total.blunt.dr}}</span>
                    <label class="left-label">P</label>
                    <span class="property-field property-field-ac">{{systemData.ac.total.piercing.ac}} / {{systemData.ac.total.piercing.dr}}</span>
                    <label class="left-label">S</label>
                    <span class="property-field property-field-ac">{{systemData.ac.total.slashing.ac}} / {{systemData.ac.total.slashing.dr}}</span>
                </div>
                {{#if systemData.ac.touch_ac}}
                <div class="property">
                    <label class="property-label">TAC</label>
                    <span class="property-field">{{systemData.ac.touch_ac}}</span>
                </div>
                {{/if}}
                {{#if systemData.ac.mr}}
                <div class="property">
                    <label class="property-label">MR</label>
                    <span class="property-field">{{systemData.ac.mr}}%</span>
                </div>
                {{/if}}
                {{#if systemData.ac.mdr}}
                <div class="property">
                    <label class="property-label">MDR</label>
                    <span class="property-field">{{systemData.ac.mdr}}</span>
                </div>
                {{/if}}
                <div class="property">
                    <label class="property-label">SV</label>
                    <span class="property-field">{{systemData.sv}}</span>
                </div>
                <div class="property">
                    <label class="property-label">MV</label>
                    <span style="margin-right:0" class="property-field">{{systemData.mv}}</span>
                </div>
            </div>

        </div>
    </header>

    {{!-- Sheet Tab Navigation --}}
    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="description">Notes</a>
        <a class="item" data-tab="items">Items</a>
        {{#if hasArmors}}
        <a class="item" data-tab="armors">Armor</a>
        {{/if}}
        {{#if hasSpells}}
        <a class="item" data-tab="spells">Spells</a>
        {{/if}}
        {{#if hasFeatures}}
        <a class="item" data-tab="features">Skills</a>
        {{/if}}
        <a class="item" data-tab="attributes">Attributes</a>
        {{#if isCharacter}}
        <a class="item" data-tab="voice">Voice</a>
        {{/if}}
        <a class="item" data-tab="fatigue">Fatigue</a>
    </nav>

    {{!-- Sheet Body --}}
    <section class="sheet-body">

        {{!-- Description Tab --}}
        <div class="tab description" data-group="primary" data-tab="description">
            {{editor content=systemData.description target="data.description" button=true owner=owner editable=editable rollData=rollData}}
        </div>

        {{!-- Owned Items Tab --}}
        <div class="tab items" data-group="primary" data-tab="items">
            <header class="items-header sticky flexrow">
                <span>Max Dex Mod: {{systemData.ac.max_dex_mod}}</span>
                <span>Worn Clo: {{fatigue.wornClo}}</span> 
                <span class="item-column">Quantity</span>
                <span class="item-column">Weight</span>
                <span style="max-width:74px;"></span>
            </header>
            {{#each equipment as |type key|}}
            <header class="items-header flexrow">
                <span></span>
                <span style="text-align: center;">
                    {{#ifeq key "holdable"}}Held{{else}}
                    {{#ifeq key "wearable"}}Worn{{else}}
                    {{#ifeq key "magic"}}Misc. Magic{{else}}
                    {{#ifeq key "other"}}Other{{else}}
                    {{key}}
                    {{/ifeq}}
                    {{/ifeq}}
                    {{/ifeq}}
                    {{/ifeq}}
                </span>
                <span></span>
            </header>
            <ol class="item-list">
                {{#each type as |item id|}}
                <li class="item flexrow" data-item-id="{{item._id}}">
                    <div class="item-toggle">
                        {{#if item.data.attributes.holdable.value}}
                        <a class="item-control {{#if item.data.held_left}}{{else}}opacity-50{{/if}}" title="Hold Item" data-type="{{item.type}}" data-action="hold_left">
                            <img style="transform: scaleX(-1);" src="https://img.icons8.com/ios-glyphs/17/000000/armored-gauntlet.png"/>
                        </a>
                        {{/if}}
                    </div>
                    <div class="item-toggle">
                        {{#if item.data.attributes.holdable.value}}
                        <a class="item-control {{#if item.data.held_right}}{{else}}opacity-50{{/if}}" title="Hold Item" data-type="{{item.type}}" data-action="hold_right">
                            <img src="https://img.icons8.com/ios-glyphs/17/000000/armored-gauntlet.png"/>
                        </a>
                        {{else if item.data.attributes.wearable.value}}
                        <a class="item-control {{#if item.data.worn}}{{else}}opacity-50{{/if}}" title="Wear Item" data-type="{{item.type}}" data-action="wear">
                            <img src="https://img.icons8.com/ios-glyphs/17/000000/armored-breastplate.png"/>
                        </a>
                        {{/if}}
                        {{#if item.data.macro}}
                        <a class="item-control" data-action="use" title="Use Item"><i class="fas fa-dice-d20"></i></a>
                        {{/if}}
                    </div>
                    <img class="item-row" data-action="edit" src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                    <h4 class="item-name item-row" data-action="edit">{{item.name}}</h4>
                    <span class="item-row item-column" data-action="edit">{{item.data.quantity}}</span>
                    <span class="item-row item-column" data-action="edit">{{item.data.totalWeight}}</span>
                    <div class="item-controls">
                        <a class="item-control" title="{{ localize "SIMPLE.ItemEdit" }}" data-type="item" data-action="edit"><i class="fas fa-edit"></i></a>
                        <a class="item-control" title="{{ localize "SIMPLE.ItemDelete" }}" data-type="item" data-action="delete"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
            {{/each}}
            <div class="flexrow" style="margin: 0.5em 0;">
                <span style="max-width:46px;">
                </span>
                <span>
                    {{#if isGM}}
                    <a class="item-control" title="{{ localize "SIMPLE.ItemCreate" }}" data-type="item" data-action="create"><i class="fas fa-plus"></i> {{ localize "SIMPLE.ItemCreate" }}</a>
                    {{/if}}
                </span>
                <span class="item-column"></span>
                <div class="item-column"><label class="label">Total:</label><span>{{systemData.enc}}</span></div>
                <span style="max-width:82px;"></span> 
            </div>
        </div>

        {{!-- Armors Tab --}}
        <div class="tab armors" data-group="primary" data-tab="armors">
            <header class="armors-header sticky flexrow">
                <span>Hit Location</span>
                <span>Armor Layers</span>
                <span class="text-center">{{#if stanceBonusText}}{{stanceBonusText}}{{/if}}</span>
                <span class="text-center">{{#if stancePenaltyText}}{{stancePenaltyText}}{{/if}}</span>
                <span class="flex2 text-center">AC / DR</span>
            </header>
            {{#each armors as |loc area|}}
            <header class="armors-header flexrow">
                <span>{{area}}</span>
            </header>
            <ol class="armors-list">
                {{#each loc as |armors key|}}
                <li class="flexrow">
                    <h4 style="flex:1">{{key}}</h4>
                    <span class="flex3">
                        {{#each armors.sortedArmors as |armor ind|}}
                        <span> {{armor}} </span>
                        {{#ifeq ind armors.sortedArmorsLastInd}}
                        {{else}}
                        <i class="fas fa-angle-right"></i>
                        {{/ifeq}}
                        {{/each}}
                    </span>
                    <span class="flex2 text-center" style="min-width:fit-content;">
                        B<span class="property-field property-field-ac">{{armors.acDr.b}}</span> 
                        P<span class="property-field property-field-ac">{{armors.acDr.p}}</span> 
                        S<span class="property-field property-field-ac">{{armors.acDr.s}}</span>
                    </span>
                </li>
                {{/each}}
            </ol>
            {{/each}}
        </div>

        {{!-- Owned Spells Tab --}}
        <div class="tab spells" data-group="primary" data-tab="spells">
            {{#each spells as |spelltype key|}}
            <header class="spells-header flexrow">
                <span>{{#if ../showSf}}{{#ifeq key "spell_magic"}} Spell Failure: {{../systemData.ac.sf}}% {{/ifeq}}{{/if}}</span>
                <span style="text-align: center;">
                    {{#ifeq key "spell_magic"}}Magic{{else}}
                    {{#ifeq key "spell_cleric"}}Cleric{{else}}
                    {{#ifeq key "spell_witch"}}Witch{{else}}
                    {{key}}
                    {{/ifeq}}
                    {{/ifeq}}
                    {{/ifeq}}
                </span>
                <span></span>
            </header>
                {{#each spelltype as |level key|}}
                <header class="spells-header flexrow">
                    <span>{{key}}</span>
                    <span style="text-align: right;">{{level.slots.value}} / {{level.slots.max}}</span>
                </header>
                <ol class="item-list">
                    {{#each level.spells as |spell|}}
                    <li class="item flexrow" data-item-id="{{spell._id}}">
                        <div class="item-toggle">
                            {{#if spell.data.macro}}
                            <a class="item-control" data-action="use" title="Cast Spell"><i class="fas fa-dice-d20"></i></a>
                            {{/if}}
                        </div>
                        <div class="item-toggle">
                            {{#if spell.data.attributes.lvl.value}}
                            <a class="item-control {{#if spell.data.prepared}}{{else}}opacity-50{{/if}}" title="Prepare Spell" data-type="{{spell.type}}" data-action="prepare">
                                <i class="fas fa-hand-sparkles"></i>
                            </a>
                            {{/if}}
                        </div>
                        <img class="item-row" data-action="edit" src="{{spell.img}}" title="{{spell.name}}" width="24" height="24"/>
                        <h4 class="item-name item-row" data-action="edit">{{spell.name}}</h4>
                        <div class="item-row flex3" data-action="edit">
                            {{#if spell.data.attributes.range.value}}<label class="label">Range:</label><span style="margin-right: 0.5em;">{{spell.data.attributes.range.value}}'</span>{{/if}}
                            {{#if spell.data.attributes.area.value}}<label class="label">Area:</label><span style="margin-right: 0.5em;">{{spell.data.attributes.area.value}}</span>{{/if}}
                            {{#if spell.data.attributes.duration.value}}<label class="label">Duration:</label><span>{{spell.data.attributes.duration.value}}</span>{{/if}}
                        </div>
                        <div class="item-controls">
                            <a class="item-control" title="{{ localize "SIMPLE.ItemEdit" }}" data-type="{{spell.type}}" data-action="edit"><i class="fas fa-edit"></i></a>
                            <a class="item-control" title="{{ localize "SIMPLE.ItemDelete" }}" data-type="{{spell.type}}" data-action="delete"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/each}}
            {{/each}}
        </div>

        {{!-- Features Tab --}}
        <div class="tab features" data-group="primary" data-tab="features">
            {{#each features as |source key|}}
            <header class="features-header flexrow">
                <span>{{#if ../showSp}} Skill Penalty: {{../sp}} {{/if}}</span>
                <span style="text-align: center;">{{key}}</span>
                <span></span>
            </header>
            <ol class="item-list">
                {{#each source as |feature id|}}
                <li class="item flexrow" data-item-id="{{feature._id}}">
                    <div class="item-toggle">
                        {{#if feature.data.macro}}
                            <a class="item-control" data-action="use" title="Use Feature"><i class="fas fa-dice-d20"></i></a>
                        {{/if}}
                    </div>
                    <img class="item-row" data-action="edit" src="{{feature.img}}" title="{{feature.name}}" width="24" height="24"/>
                    <h4 class="item-name item-row" data-action="edit">{{feature.name}}</h4>
                    <div class="item-row flex2" data-action="edit">
                        {{#if feature.st}}<label class="label">ST:</label><span>{{feature.st}}</span>{{/if}}
                    </div>
                    <div class="item-controls">
                        <a class="item-control" title="{{ localize "SIMPLE.ItemEdit" }}" data-type="feature" data-action="edit"><i class="fas fa-edit"></i></a>
                        <a class="item-control" title="{{ localize "SIMPLE.ItemDelete" }}" data-type="feature" data-action="delete"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
            {{/each}}
            <div class="flexrow" style="margin: 0.5em 0;">
                <span style="max-width:23px;">
                </span>
                <span>
                    {{#if isGM}}
                    <a class="item-control" title="{{ localize "SIMPLE.ItemCreate" }}" data-type="feature" data-action="create"><i class="fas fa-plus"></i> Create Feature </a>
                    {{/if}}
                </span>
            </div>
        </div>

        {{!-- Attributes Tab --}}
        <div class="tab attributes" data-group="primary" data-tab="attributes">
            {{#if isGM}}
            <header class="attributes-header flexrow sticky">
                <span class="attribute-key attribute-key-wrapper">{{localize "SIMPLE.AttributeKey"}}</span>
                <span class="attribute-label attribute-key-wrapper">{{localize "SIMPLE.AttributeLabel"}}</span>
                <span class="attribute-value">{{localize "SIMPLE.AttributeValue"}}</span>
                <span class="attribute-dtype">{{localize "SIMPLE.AttributeDtype"}}</span>
                <a class="attribute-control" data-action="create" data-group="{{group}}"><i class="fas fa-plus"></i></a>
            </header>
            {{/if}}

            {{!-- Render the attribute list partial. --}}
            {{> "systems/lostlands/templates/parts/sheet-attributes.html" attributes=systemData.ungroupedAttributes dtypes=dtypes}}

            {{!-- Render the grouped attributes partial and control. --}}
            <div class="groups">
                {{> "systems/lostlands/templates/parts/sheet-groups.html" attributes=systemData.groupedAttributes groups=systemData.groups dtypes=dtypes}}

                {{#if isGM}}
                <div class="group-controls flexrow">
                    <input class="group-prefix" type="text" value=""/>
                    <a class="button group-control" data-action="create-group"><i class="fas fa-plus"></i>Add Attribute Group</a>
                </div>
                {{/if}}
            </div>
        </div>

        {{!-- Fatigue Tab --}}
        <div class="tab fatigue" data-group="primary" data-tab="fatigue">
            {{#if isCharacter}}
            <div class="flexrow">
                <label class="fatigue-label">Ambient Temp.</label>
                <span class="fatigue-value">{{fatigue.tempDesc}}</span>
            </div>
            <div class="flexrow">
                <label class="fatigue-label">Exposure</label>
                <span class="fatigue-value">{{fatigue.exposureDesc}}</span>
            </div>
            <div class="flexrow">
                <label class="fatigue-label">Thirst</label>
                <span class="fatigue-value">{{fatigue.thirstDesc}}</span>
            </div>
            <div class="flexrow">
                <label class="fatigue-label">Exhaustion</label>
                <span class="fatigue-value">{{fatigue.exhaustionDesc}}</span>
            </div>
            <div class="flexrow">
                <label class="fatigue-label">Hunger</label>
                <span class="fatigue-value">{{fatigue.hungerDesc}}</span>
            </div>
            <div class="flexrow">
                <label class="fatigue-label">Disease</label>
                <span class="fatigue-value">{{fatigue.diseaseDesc}}</span>
            </div>
            {{/if}}
            <div class="flexrow">
                <label class="fatigue-label">Injuries</label>
                <input class="fatigue-value" type="text" name="data.injuries" value="{{systemData.injuries}}" {{#if isPlayer}}readonly{{/if}}/>
            </div>
        </div>

        {{#if isCharacter}}
        {{!-- Voice Tab --}}
        <div class="tab voice" data-group="primary" data-tab="voice">
            <div class="flexrow voice-selection" {{#if hideVoiceSelection}}style="display:none;"{{/if}}>
                <div class="voice-choice">
                    <label>Voice</label>
                    <select class="voice-select" {{#if hasVoice}}disabled{{/if}}>
                        {{#select systemData.voice}}
                        {{#each voiceProfiles}}
                        <option value="{{this}}">{{this}}</option>
                        {{/each}}
                        {{/select}}
                    </select>
                    <a class="voice-preview" title="Preview Voice"><i class="fas fa-volume-up"></i></a>
                </div>
                <div><button class="voice-select-button" {{#if hasVoice}}disabled{{/if}}>Select voice</button></div>
                {{#if isGM}}
                <div><button class="voice-reset-button" {{#if noVoice}}disabled{{/if}}>Reset voice</button></div>
                {{/if}}
            </div>
            {{#if noVoice}}
            <p class="voice-note"><span class="label">Note:</span>Before selecting your voice, any sounds you play using the preview button will be audible only to you.
                After selecting your voice, sounds you play here will be audible to everyone.
            </p>
            {{/if}}
            {{#if showSoundBoard}}
            {{#each voiceMoods}}
            <button class="voice-play" title="{{#ifeq this.mood 'party_fail'}}facepalm{{else}}{{#ifeq this.mood 'party_death'}}rip{{else}}{{#ifeq this.mood 'death'}}dying{{else}}{{#ifeq this.mood 'dying'}}wounded{{else}}{{this.mood}}{{/ifeq}}{{/ifeq}}{{/ifeq}}{{/ifeq}}" data-mood="{{this.mood}}">
                <img style="pointer-events: none;" src="{{this.icon}}" alt="{{#ifeq this.mood 'party_fail'}}facepalm{{else}}{{#ifeq this.mood 'party_death'}}rip{{else}}{{#ifeq this.mood 'death'}}dying{{else}}{{#ifeq this.mood 'dying'}}wounded{{else}}{{this.mood}}{{/ifeq}}{{/ifeq}}{{/ifeq}}{{/ifeq}}"/>
            </button>
            {{/each}}
            {{/if}}
        </div>
        {{/if}}

    </section>
</form>